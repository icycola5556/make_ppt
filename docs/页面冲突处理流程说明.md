# 页面冲突智能处理完整流程说明

## 修改后的完整流程

### 阶段1：初始意图理解（3.1模块）

1. **用户输入初始需求**
   - 用户输入：例如"给我一个机械专业「液压传动原理」的理论课课件，10页左右"
   - 系统调用LLM进行意图理解，提取结构化信息

2. **信息补充交互**
   - 如果缺少必要信息（学科、知识点等），系统询问用户补充
   - 用户补充知识点、确认配置等
   - **注意**：此时**不进行**页面冲突检查和LLM推荐

### 阶段2：配置确认

3. **知识点确认**
   - 用户确认是否需要补充更多知识点
   - 如果补充，进入`add_additional_kps`阶段

4. **配置修改询问**
   - 系统询问是否需要修改默认配置（课时、案例、习题、互动）
   - 用户可以选择修改或保持默认

5. **进入确认阶段**
   - 所有信息补充完成后，进入`confirm_goals`阶段

### 阶段3：页面冲突检测与处理（关键改进点）

6. **在confirm_goals阶段检查页面冲突**
   - **时机**：在用户看到最终确认摘要之前
   - **触发条件**：`target_count < min_count`
   - **LLM推荐调用**：
     - 如果检测到冲突且LLM启用，自动调用`recommend_slide_count_with_llm`
     - 分析知识点复杂度、教学内容量、教学场景、特殊需求
     - 返回推荐页数和详细说明

7. **显示页面冲突交互界面**
   - 如果检测到冲突，显示页面冲突问题（`slide_count_adjust`）
   - 显示内容：
     - 当前目标页数
     - 系统建议最小页数
     - AI推荐页数（如果有）
     - 推荐理由说明
   - 提供三个选项：
     - ✅ 接受推荐（调整为推荐页数）
     - ✏️ 自定义页数
     - ⚠️ 保持原页数（后续会智能调整）

8. **用户选择处理方式**
   - **接受推荐**：直接更新`target_count`为推荐值，进入最终确认
   - **自定义页数**：跳转到`confirm_pages`阶段，显示输入框让用户输入
   - **保持原页数**：保持原值，记录需要后续智能调整，进入最终确认

9. **自定义页数输入（如选择）**
   - 在`confirm_pages`阶段显示输入框
   - 用户输入自定义页数
   - 系统验证并更新`target_count`
   - 完成后进入最终确认

### 阶段4：最终确认与生成

10. **最终确认**
    - 显示完整的教学需求摘要
    - 用户确认后，`interaction_stage`变为`confirmed`

11. **生成大纲（3.3模块）**
    - 调用LLM生成PPT大纲（`generate_outline_with_llm`）
    - 如果生成的页数超过`target_count`，调用智能调整函数`_adjust_outline_to_target_count`
    - 使用三级优先级策略：
      - 优先级1：移除非教学必需页面（agenda, warning, qa）
      - 优先级2：合并同主题内容页（intro+concept, 案例页, 练习页）
      - 优先级3：精简内容（最后手段）

12. **输出最终大纲（outline_final）**
    - 确保页数符合要求
    - 保持教学逻辑完整性

## 关键改进点

### 1. 时机调整
- **之前**：在补充知识点后立即调用LLM推荐（过早）
- **现在**：在`confirm_goals`阶段，所有信息确认后调用（正确时机）

### 2. 交互界面
- **之前**：页面冲突问题可能没有正确显示
- **现在**：在`confirm_goals`阶段明确检查并显示，确保用户能看到

### 3. 流程顺序
- **之前**：页面冲突检查在`confirm_kp`阶段（信息可能不完整）
- **现在**：页面冲突检查在`confirm_goals`阶段（信息已完整）

## 代码修改位置

### backend/app/workflow.py
- **修改位置**：`run`方法中，在`validate_and_build_questions`之后
- **关键逻辑**：在`confirm_goals`阶段且没有其他问题时，检查页面冲突并调用LLM推荐

### backend/app/intent.py
- **validate_and_build_questions**：
  - 移除了`confirm_kp`阶段的页面冲突检查
  - 在`confirm_goals`阶段添加页面冲突检查
- **apply_user_answers**：
  - 在`confirm_goals`阶段处理页面冲突选择
  - 在`confirm_pages`阶段处理自定义页数输入

### backend/app/outline.py
- **智能调整策略**：三级优先级合并精简策略
- **辅助函数**：各种合并和精简函数

### frontend/src/App.vue
- **UI优化**：页面冲突特殊样式显示
- **自定义输入**：条件显示自定义页数输入框

![34c78eb589e3315a93c62b73596a7ebd](D:\Users\PC\Documents\xwechat_files\wxid_mw7sl7fx01lc11_f3c0\temp\RWTemp\2026-01\9a9964ace641f5b5085d7da5e9a56e1a\34c78eb589e3315a93c62b73596a7ebd.png)

## 流程图

```
用户输入
  ↓
LLM意图理解
  ↓
信息补充交互（知识点、配置等）
  ↓
confirm_goals阶段
  ↓
检查页面冲突？
  ├─ 是 → 调用LLM推荐页数
  │      ↓
  │   显示冲突交互界面
  │      ↓
  │   用户选择处理方式
  │      ├─ 接受推荐 → 更新target_count
  │      ├─ 自定义 → 输入自定义页数
  │      └─ 保持原值 → 记录需要调整
  │      ↓
  └─ 否 → 直接进入最终确认
      ↓
最终确认（final_confirm）
  ↓
生成大纲（3.3模块）
  ↓
智能调整（如需要）
  ↓
输出outline_final
```

## 注意事项

1. **LLM推荐时机**：必须在所有信息确认后，final_confirm之前
2. **交互界面显示**：确保页面冲突问题能正确显示在前端
3. **智能调整**：如果用户选择保持原页数，在大纲生成后使用智能合并策略
4. **教学逻辑完整性**：确保合并和精简不破坏教学逻辑
