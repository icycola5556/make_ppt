# 工具调用功能说明

## 概述

在意图理解模块（3.1）中，系统现在支持模型自主使用工具的功能，特别是**联网搜索**功能。当模型遇到不熟悉的知识点、专业术语或需要验证的信息时，可以自动调用搜索工具获取最新信息，从而更准确地理解用户意图。

## 功能特点

1. **自动工具调用**：模型可以根据需要自主决定是否使用搜索工具
2. **多轮对话**：支持工具调用后的多轮交互，直到获得最终结果
3. **完整日志**：所有工具调用都会被记录到日志中，便于追踪和调试
4. **降级处理**：如果工具调用失败，系统会自动降级到原有的解析方式

## 实现原理

### 1. 工具定义

系统定义了 `web_search` 工具，遵循 OpenAI 工具调用格式：

```python
{
    "type": "function",
    "function": {
        "name": "web_search",
        "description": "在互联网上搜索相关信息...",
        "parameters": {
            "type": "object",
            "properties": {
                "query": {
                    "type": "string",
                    "description": "搜索查询关键词"
                },
                "max_results": {
                    "type": "integer",
                    "description": "返回的最大结果数量",
                    "default": 3
                }
            },
            "required": ["query"]
        }
    }
}
```

### 2. LLM 客户端扩展

`LLMClient` 类新增了 `chat_with_tools` 方法，支持：
- 工具定义传递
- 工具调用检测
- 工具结果处理
- 多轮对话循环

### 3. 工具执行器

`ToolExecutor` 类负责：
- 管理所有可用工具
- 根据工具名称执行对应函数
- 返回标准化的工具结果

### 4. 意图理解流程更新

`_parse_intent` 方法现在支持：
- 可选的工具调用模式（`use_tools` 参数）
- 工具调用历史记录
- 工具调用后的JSON解析

## 使用方法

### 基本使用

工具调用功能默认启用。在意图理解阶段，系统会自动判断是否需要使用搜索工具。

### 配置搜索后端

#### 方案1：使用 DuckDuckGo（推荐，免费）

```bash
pip install duckduckgo-search
```

这是推荐的方案，因为：
- 完全免费，无需API密钥
- 支持中文搜索
- 结果质量较好

#### 方案2：使用其他搜索API

如果需要使用 Google Custom Search、Bing Search 或其他搜索API，可以修改 `backend/app/tools.py` 中的 `execute_web_search` 函数。

### 禁用工具调用

如果需要禁用工具调用功能，可以在 `workflow.py` 中修改：

```python
req = await self._parse_intent(session_id, user_text, use_tools=False)
```

## Prompt 设计

系统 Prompt 已经更新，引导模型在以下情况使用搜索工具：

1. **遇到不熟悉的知识点**：需要了解知识点的具体内容
2. **专业术语验证**：确认术语的正确性和含义
3. **最新标准查询**：获取行业最新标准或教学规范
4. **教学案例查找**：寻找相关的教学案例或应用场景
5. **专业领域确认**：验证专业领域分类是否正确

## 日志记录

所有工具调用都会被记录到日志中：

- `3.1/tool_calls`：记录工具调用历史，包括：
  - 工具名称
  - 调用参数
  - 执行结果

示例日志：

```json
{
  "stage": "3.1",
  "kind": "tool_calls",
  "payload": {
    "tool_calls": [
      {
        "tool_name": "web_search",
        "arguments": {
          "query": "液压传动原理 高职教学",
          "max_results": 3
        },
        "result": {
          "success": true,
          "results": [...]
        }
      }
    ]
  }
}
```

## 注意事项

1. **API兼容性**：确保使用的LLM API支持工具调用功能（OpenAI GPT-4、DeepSeek等）
2. **搜索库安装**：虽然系统可以在没有搜索库的情况下运行，但建议安装 `duckduckgo-search` 以获得更好的搜索体验
3. **性能考虑**：工具调用会增加响应时间，因为需要等待搜索完成
4. **成本考虑**：如果使用付费搜索API，会产生额外费用

## 扩展其他工具

如果需要添加其他工具（如计算器、数据库查询等），可以：

1. 在 `tools.py` 中定义工具函数
2. 在 `get_xxx_tool_definition()` 中定义工具描述
3. 在 `ToolExecutor.__init__` 中注册工具
4. 在 `get_tool_definitions()` 中添加工具定义

示例：

```python
# 1. 定义工具函数
async def execute_calculator(expression: str) -> Dict[str, Any]:
    # 实现计算逻辑
    pass

# 2. 定义工具描述
def get_calculator_tool_definition() -> Dict[str, Any]:
    return {
        "type": "function",
        "function": {
            "name": "calculator",
            "description": "执行数学计算",
            "parameters": {...}
        }
    }

# 3. 在ToolExecutor中注册
self.tools["calculator"] = execute_calculator
```

## 故障排查

### 问题：工具调用不工作

1. 检查LLM API是否支持工具调用
2. 检查 `use_tools` 参数是否为 `True`
3. 查看日志中的错误信息

### 问题：搜索返回空结果

1. 检查是否安装了 `duckduckgo-search`
2. 检查网络连接
3. 尝试调整搜索关键词

### 问题：JSON解析失败

1. 检查模型是否返回了有效的JSON
2. 查看日志中的 `raw_content` 字段
3. 考虑增加 `max_iterations` 参数

## 总结

通过添加工具调用功能，意图理解模块现在可以：
- 自动获取最新信息
- 验证不确定的知识点
- 提供更准确的意图解析
- 支持更复杂的教学需求理解

这大大提升了系统的智能程度和准确性。

