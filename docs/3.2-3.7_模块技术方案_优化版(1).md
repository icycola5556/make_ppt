# 3.2-3.7 模块技术方案（优化版）

本文档基于实际代码实现和 JSON Schema 定义，详细说明 3.2-3.7 各模块的功能、输入输出和实现细节。文档风格参照 3.1 意图理解模块优化版。

---

## 3.2 模块二：PPT风格设计

本模块根据 3.1 意图理解模块的教学需求，自动匹配并生成标准化的课件风格配置方案。

### 3.2.1 核心功能

- **场景驱动风格匹配**：根据教学场景（理论课/实训课/复习课）自动选择对应风格模板
- **专业领域适配**：根据专业类别调整色彩和视觉风格
- **用户定制支持**：支持警示色等个性化配置

### 3.2.2 风格模板库

系统预置三套风格模板，覆盖高职教学主要场景：

| 模板名称 | 适用场景 | 主色调 | 布局特点 |
|----------|----------|--------|----------|
| **theory_clean** | 理论讲授 | #1F4E79（深蓝） | 左对齐，舒适密度，带标题线 |
| **practice_steps** | 实训操作 | #166534（绿色） | 左对齐，紧凑密度，步骤面板 |
| **review_mindmap** | 复习巩固 | #4C1D95（紫色） | 居中对齐，思维导图风格 |

### 3.2.3 风格匹配算法

```
输入：TeachingRequest.teaching_scene
映射逻辑：
  - practice → practice_steps
  - review → review_mindmap
  - theory/unknown → theory_clean
```

### 3.2.4 输出结果

生成标准化风格配置文档（`StyleConfig`），包含以下字段：

| 字段名称 | 子字段 | 数据类型 | 说明 |
|----------|--------|----------|------|
| **style_name** | - | 字符串 | 风格模板名称 |
| **color** | primary | 字符串 | 主色调（如 #1F4E79） |
| | secondary | 字符串 | 辅助色 |
| | accent | 字符串 | 强调色 |
| | text | 字符串 | 文本颜色 |
| | background | 字符串 | 背景色 |
| | warning | 字符串 | 警示色（如 #DC2626） |
| **font** | title_family | 字符串 | 标题字体（默认微软雅黑） |
| | body_family | 字符串 | 正文字体 |
| | title_size | 整数 | 标题字号（34-36） |
| | body_size | 整数 | 正文字号（22） |
| | line_height | 浮点数 | 行高（1.15-1.2） |
| **layout** | density | 枚举 | 信息密度（comfortable/compact） |
| | notes_area | 布尔值 | 是否保留备注区 |
| | alignment | 枚举 | 对齐方式（left/center） |
| **imagery** | image_style | 字符串 | 图片风格（clean_diagram/photo_or_step_diagram） |
| | icon_style | 字符串 | 图标风格（linear/instruction） |
| | chart_preference | 数组 | 图表偏好（mindmap/flow/table） |

### 3.2.5 风格样例生成

模块同时生成3个风格样例页面（`StyleSampleSlide`）供预览：

| 样例类型 | 用途 |
|----------|------|
| **cover** | 封面页样例 |
| **content** | 内容页样例 |
| **steps** | 步骤/案例页样例 |

### 3.2.6 与后续模块联动

| 后续模块 | 联动内容 |
|----------|----------|
| 3.3 大纲生成 | 传递 `style_name` 用于页面类型规划 |
| 3.4 内容生成 | 传递完整 `StyleConfig` 用于布局和视觉元素渲染 |

---

## 3.3 模块三：PPT大纲生成

本模块根据教学需求和风格定位，生成结构化的教学大纲，包含逐页标题、要点和交互设计。

### 3.3.1 核心功能

- **智能页面规划**：根据知识点数量和教学场景自动分配页面
- **教学逻辑编排**：按照"封面→目标→导入→讲解→案例→练习→总结"的逻辑顺序组织内容
- **素材占位定义**：为每页预定义图片、图表等素材需求

### 3.3.2 页面类型体系

系统支持以下12种页面类型（slide_type）：

| 类型代码 | 中文名称 | 说明 |
|----------|----------|------|
| cover | 封面 | 课件标题页 |
| agenda | 目录 | 教学内容导航（可选） |
| objectives | 目标 | 教学目标展示 |
| intro | 导入 | 情景引入/问题导入 |
| concept | 概念 | 核心概念定义 |
| steps | 步骤 | 操作步骤说明（实训课） |
| warning | 注意 | 安全警示/易错点 |
| exercises | 练习 | 习题/巩固练习 |
| summary | 总结 | 知识点归纳 |
| relations | 联系 | 知识关联图 |
| bridge | 过渡 | 衔接页 |
| qa | 问答 | 互动问答页 |

### 3.3.3 大纲生成算法

**页面分配逻辑**：

1. **固定页面**：封面(1) + 目标(1) + 总结(1) = 3页
2. **可选目录页**：agenda（根据页面总数和教学场景决定是否包含）
3. **知识点内容页**：每个知识点 2-3 页（导入/概念/讲解）
   - 简单知识点(easy): 1-2页
   - 中等知识点(medium): 2-3页
   - 困难知识点(hard): 3-4页
4. **案例页**：根据 `special_requirements.cases.count` 决定（使用 `concept` 类型，标题标注为案例）
5. **练习页**：根据 `special_requirements.exercises.total_count` 决定（每页约3道题）
6. **互动页**：根据 `special_requirements.interaction.types` 决定（使用 `qa` 类型，最多2页）

**页面数量控制**：
- 系统会根据 `slide_requirements.target_count` 控制总页数
- 如果生成的大纲页数超过目标，会在3.3模块后执行智能调整（见3.3.6节）

### 3.3.4 输出结果

生成层级化PPT大纲（`PPTOutline`），包含以下字段：

**大纲主体**

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| **deck_title** | 字符串 | 课件总标题 |
| **subject** | 字符串 | 授课学科 |
| **knowledge_points** | 字符串数组 | 知识点名称列表 |
| **teaching_scene** | 枚举 | 教学场景（theory/practice/review） |
| **slides** | 对象数组 | 逐页大纲列表 |

**单页大纲 (`OutlineSlide`)**

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| **index** | 整数 | 页面序号（从1开始） |
| **slide_type** | 字符串 | 页面类型（见页面类型体系表） |
| **title** | 字符串 | 页面标题 |
| **bullets** | 字符串数组 | 核心要点列表（可为空数组，如cover页） |
| **notes** | 字符串或null | 教师备注（可选，通常为null） |
| **interactions** | 字符串数组 | 互动设计（可为空数组，如"提问互动：请举例说明帕斯卡原理"） |
| **assets** | 对象数组 | 素材占位定义（可为空数组） |

**素材占位定义**

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| type | 字符串 | 素材类型（image/diagram/chart/icon） |
| theme | 字符串 | 主题描述（如"液压系统原理图"） |
| size | 字符串 | 尺寸建议（small/medium/large 或比例值 16:9/4:3/1:1） |
| style | 字符串 | 风格要求（photo/illustration/schematic/mindmap/flow） |

### 3.3.5 LLM优化机制

如果启用LLM，系统会对基础大纲进行优化：
- 优化页面标题，使其更具教学吸引力
- 完善要点表述，符合高职学生认知特点
- 补充互动设计，提升课堂参与度
- 根据知识点数量和难度智能分配页面，确保符合 `target_count` 要求

**LLM输入格式**：
- 接收完整的 `TeachingRequest` 对象（包含所有教学需求信息）
- 接收 `estimated_page_distribution`（页面分布估计）
- 接收 `style_name`（风格名称，用于页面类型规划）

**LLM输出格式**：
- 严格按照 `PPTOutline` JSON Schema 输出
- 确保页面数量符合 `target_count` 要求
- 所有字段必须完整（bullets、interactions、assets 可为空数组）

### 3.3.6 页面冲突智能调整

在3.1模块完成后、3.3模块执行前，系统会进行页面冲突检测和智能调整：

**检测时机**：
- 在 `confirm_goals` 阶段（所有信息确认后）
- 检查 `target_count < min_count` 是否存在冲突

**处理流程**：
1. **冲突检测**：比较用户期望页数（`target_count`）与系统计算的最小页数（`min_count`）
2. **LLM推荐**：如果检测到冲突且LLM可用，调用LLM推荐合适的页数
3. **用户交互**：显示冲突警告和推荐结果，提供三种选择：
   - 接受推荐页数
   - 自定义页数
   - 保持原页数（后续智能调整）
4. **智能调整**：如果用户选择保持原页数或自定义页数仍不足，在3.3模块生成大纲后执行智能调整：
   - **优先级1**：移除非必要页面（agenda、warning、qa）
   - **优先级2**：合并相似内容页面（intro+concept、多个case、多个exercises）
   - **优先级3**：内容简化（嵌入warning内容到相关页、嵌入qa到互动页）

**调整策略**（在 `outline.py` 的 `_adjust_outline_to_target_count` 函数中实现）：
- 确保核心知识点内容完整
- 优先保留固定页面（cover、objectives、summary）
- 智能合并而非简单删除

---

## 3.4 模块四：PPT页面内容生成

本模块根据大纲和风格配置，生成每页的具体内容，包括文本、布局和视觉元素。

### 3.4.1 核心功能

- **逐页内容生成**：为每个大纲页面生成详细内容
- **布局自动分配**：根据内容类型选择合适的页面布局
- **元素定位**：使用归一化坐标系定义元素位置

### 3.4.2 设计原则

系统遵循以下内容生成原则（详见代码中的 CONTENT_SYSTEM_PROMPT）：

- **内容驱动的选择**：让每页的内容目的决定标题和要点设计
- **教学逻辑递进**：确保页面间的逻辑流畅
- **实用性优先**：避免华而不实的表达
- **受众适配**：针对高职学生特点优化语言

### 3.4.3 布局坐标系

使用 16:9 比例的归一化坐标系（坐标值范围 0-1）：

| 区域 | x | y | w | h |
|------|---|---|---|---|
| 页面标题区 | 0.05 | 0.05 | 0.9 | 0.12 |
| 左侧内容区 | 0.05 | 0.20 | 0.42 | 0.65 |
| 右侧内容区 | 0.52 | 0.20 | 0.42 | 0.65 |
| 全宽内容区 | 0.05 | 0.20 | 0.9 | 0.65 |
| 页脚备注区 | 0.06 | 0.92 | 0.88 | 0.06 |

### 3.4.4 元素类型体系

系统支持以下8种元素类型（`SlideElement.type`）：

| 类型 | 说明 | 典型用途 |
|------|------|----------|
| **text** | 文本块 | 标题、段落 |
| **bullets** | 要点列表 | 核心要点展示 |
| **image** | 图片占位 | 示意图、照片 |
| **shape** | 形状 | 装饰元素 |
| **table** | 表格 | 数据对比 |
| **chart** | 图表 | 数据可视化 |
| **diagram** | 图解 | 流程图、关系图 |
| **quiz** | 互动题 | 练习题、选择题 |

### 3.4.5 输出结果

生成完整课件内容（`SlideDeckContent`），包含以下字段：

**课件主体**

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| **deck_title** | 字符串 | 课件总标题 |
| **pages** | 对象数组 | 逐页内容列表 |

**单页内容 (`SlidePage`)**

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| **index** | 整数 | 页面序号 |
| **slide_type** | 字符串 | 页面类型 |
| **title** | 字符串 | 页面标题 |
| **layout** | 对象 | 布局配置（模板名称+参数） |
| **elements** | 对象数组 | 页面元素列表 |
| **speaker_notes** | 字符串 | 演讲者备注（可选） |

**页面元素 (`SlideElement`)**

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| **id** | 字符串 | 元素唯一标识（UUID） |
| **type** | 枚举 | 元素类型 |
| **x** | 浮点数 | 横向位置（0-1） |
| **y** | 浮点数 | 纵向位置（0-1） |
| **w** | 浮点数 | 宽度（0-1） |
| **h** | 浮点数 | 高度（0-1） |
| **content** | 对象 | 元素内容（按类型不同） |
| **style** | 对象 | 样式覆盖 |

### 3.4.6 内容生成流程

1. **基础内容生成**（`build_base_deck`）：确定性生成，不依赖LLM
2. **LLM内容优化**（`refine_with_llm`）：调用大模型优化文本表述
3. **内容校验**（`validate_deck`）：验证页面数量和结构完整性

### 3.4.7 质量校验规则

- 页面数量必须与大纲一致
- 每页必须包含标题
- 核心内容页必须包含要点列表

---

## 3.5 模块五：渲染为网页幻灯片

本模块将生成的页面内容渲染为交互式网页幻灯片（规划功能）。

### 3.5.1 核心功能

- **HTML渲染**：将 `SlideDeckContent` 转换为 HTML/CSS/JS
- **响应式适配**：支持PC、平板、手机等多设备
- **交互功能**：支持键盘/触摸翻页、知识点跳转

### 3.5.2 技术栈

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 渲染引擎 | reveal.js | 成熟的网页幻灯片框架 |
| 样式系统 | CSS Variables | 支持主题动态切换 |
| 交互逻辑 | Vanilla JavaScript | 轻量级交互实现 |

### 3.5.3 输出格式

- **HTML文件**：单文件自包含网页
- **资源目录**：图片、字体等静态资源

---

## 3.6 模块六：AI教学素材生成与匹配

本模块为课件页面匹配和生成合适的教学素材，支持知识库检索和AI实时生成两种模式。

### 3.6.1 核心功能

- **知识库检索**：从公司自建知识库中检索匹配的教学素材
- **AI素材生成**：调用AI图像生成API实时生成教学插图
- **智能推荐**：基于教学场景和专业领域推荐合适素材

### 3.6.2 素材来源策略

系统支持多种素材来源，按优先级排序：

| 优先级 | 来源 | 说明 | 适用场景 |
|--------|------|------|----------|
| 1 | **公司知识库** | 企业自建的专业素材库 | 知识库建设完成后首选 |
| 2 | **AI实时生成** | 调用AI图像生成API | 知识库缺失或需定制素材 |
| 3 | **开源素材库** | Unsplash、Pexels等 | 通用场景图片 |
| 4 | **图标库** | IconFont、FontAwesome | 分类标识图标 |

### 3.6.3 公司知识库方案

采用 RAG（检索增强生成）架构，与公司现有知识库系统对接：

**检索流程**：
```
素材需求描述 → 向量化 → 相似度检索 → 素材候选列表 → 风格筛选 → 最终素材
```

**知识库分类体系**：

| 分类 | 子类 | 示例 |
|------|------|------|
| **工程类** | 机械图/电气图/液压图 | 齿轮传动示意图、液压系统原理图 |
| **医护类** | 解剖图/操作流程图/器械图 | 静脉输液操作步骤图 |
| **农林类** | 植物图/动物图/生态图 | 作物生长周期图 |
| **商科类** | 数据图/流程图/组织图 | 财务报表可视化 |

### 3.6.4 AI素材生成方案

当知识库未建设完成或缺少特定素材时，系统调用AI图像生成接口实时生成。

#### 推荐模型对比

| 模型 | 厂商 | 优势 | 适用场景 | API成本 |
|------|------|------|----------|---------|
| **Flux.1 Pro** | Black Forest Labs | 最高质量、复杂构图、准确文字渲染 | 专业教学插图、带标注图 | 较高 |
| **Flux.1 Dev** | Black Forest Labs | 开放权重、可定制、性价比高 | 批量生成、风格统一 | 中等 |
| **Flux.1 Schnell** | Black Forest Labs | 速度最快（4步生成） | 原型验证、实时预览 | 较低 |
| **DALL-E 3** | OpenAI | 自然语言理解强、支持中文 | 概念图、创意插图 | 中等 |
| **Stable Diffusion XL** | Stability AI | 开源可自部署、高度可控 | 需要本地部署的场景 | 自部署 |

#### 推荐方案：Flux.1 Dev

基于综合考量，**推荐使用 Flux.1 Dev** 作为主要AI素材生成引擎：

**选择理由**：
1. **质量优异**：在文字渲染和复杂指令理解上优于其他开源模型
2. **成本可控**：比Pro版便宜，适合批量生成
3. **API稳定**：支持 Together AI、Replicate、fal.ai 等多个托管平台
4. **支持LoRA**：可训练专属教学风格模型

**API调用示例**：

```python
import replicate

def generate_teaching_image(prompt: str, style: str = "教学插图") -> str:
    """调用 Flux.1 Dev 生成教学素材"""
    
    full_prompt = f"""
    专业教学插图风格，{style}。
    内容：{prompt}
    要求：清晰的线条，适合PPT展示，白色背景，扁平化设计，
    标注清晰，中文标签，16:9比例。
    """
    
    output = replicate.run(
        "black-forest-labs/flux-dev",
        input={
            "prompt": full_prompt,
            "aspect_ratio": "16:9",
            "output_format": "png",
            "output_quality": 90,
            "num_inference_steps": 28,
        }
    )
    return output[0]  # 返回图片URL
```

#### 教学素材Prompt模板

针对不同专业领域，预设优化的Prompt模板：

| 专业领域 | Prompt模板 | 生成风格 |
|----------|------------|----------|
| **工程类** | "技术图纸风格，{主题}的工作原理示意图，标注关键部件，蓝色色调" | 工程制图风格 |
| **医护类** | "医学教学插图，{主题}的操作流程，步骤编号，专业医疗配色" | 医学手册风格 |
| **农林类** | "自然科学插图，{主题}的生态关系图，绿色为主，写实风格" | 科普绘本风格 |
| **商科类** | "商务信息图，{主题}的数据可视化，现代扁平设计，蓝灰色调" | 信息图风格 |

### 3.6.5 素材匹配算法

```
输入：OutlineSlide.assets[] 中的素材定义
处理流程：
  1. 解析素材需求（type, theme, style, size）
  2. 优先检索知识库
     - 有匹配结果 → 返回素材URL
     - 无匹配结果 → 进入AI生成流程
  3. AI生成流程
     - 根据 theme 构建 Prompt
     - 根据 professional_category 选择 Prompt 模板
     - 调用 Flux.1 API 生成图片
     - 缓存生成结果
  4. 后处理
     - 根据 size 调整尺寸
     - 添加素材元数据
输出：素材URL或Base64数据
```

### 3.6.6 输出规格

| 素材类型 | 推荐尺寸 | 格式 | 说明 |
|----------|----------|------|------|
| 全页背景 | 1920×1080 | PNG/JPG | 16:9 比例 |
| 内容插图 | 800×600 | PNG | 透明背景优先 |
| 图标 | 128×128 | SVG/PNG | 矢量优先 |
| 流程图 | 1200×600 | PNG | 保证文字清晰 |

---

## 3.7 模块七：网页版PPT转换为PPTX文件

本模块将网页版幻灯片导出为标准PowerPoint格式（.pptx），便于教师在办公软件中编辑和使用。

### 3.7.1 核心功能

- **格式转换**：将HTML幻灯片转换为PPTX格式
- **样式保持**：尽可能保留原有的颜色、字体、布局
- **素材嵌入**：将图片等素材嵌入PPTX文件
- **可编辑性**：确保导出的PPTX可在PowerPoint中正常编辑

### 3.7.2 技术方案对比

| 方案 | 技术栈 | 优点 | 缺点 |
|------|--------|------|------|
| **python-pptx** | Python | 原生生成PPTX，高可控性 | 需要重新布局 |
| **pptxgenjs** | JavaScript | 前端直接生成，无需服务端 | 复杂布局支持有限 |
| **LibreOffice** | 服务端转换 | HTML→ODP→PPTX，格式兼容好 | 需要安装LibreOffice |
| **第三方API** | CloudConvert等 | 无需维护，高质量 | 有成本，依赖外部服务 |

### 3.7.3 推荐方案：python-pptx

采用 **python-pptx** 作为主要转换工具：

**选择理由**：
1. **纯Python实现**：无需安装额外软件
2. **高可控性**：精确控制每个元素的位置和样式
3. **与现有架构一致**：后端统一使用Python
4. **成熟稳定**：社区活跃，文档完善

### 3.7.4 转换流程

```
SlideDeckContent (JSON)
    ↓
解析页面结构
    ↓
创建PPTX Presentation
    ↓
逐页转换：
    ├─ 创建幻灯片
    ├─ 添加标题文本框
    ├─ 添加内容元素
    │   ├─ text → TextFrame
    │   ├─ bullets → TextFrame with bullets
    │   ├─ image → Picture
    │   ├─ table → Table
    │   └─ chart → Chart
    ├─ 应用样式（颜色、字体）
    └─ 添加演讲者备注
    ↓
保存PPTX文件
```

### 3.7.5 元素映射规则

| SlideElement类型 | PPTX元素 | 说明 |
|------------------|----------|------|
| text | TextFrame | 普通文本框 |
| bullets | TextFrame + Paragraph | 带项目符号的列表 |
| image | Picture | 插入图片，支持URL和Base64 |
| table | Table | GraphicFrame表格 |
| chart | Chart | GraphicFrame图表 |
| shape | Shape | 基础形状 |
| diagram | GroupShape | 组合形状（流程图等） |

### 3.7.6 坐标转换

将归一化坐标转换为PPTX坐标单位（EMU）：

```python
from pptx.util import Inches, Pt, Emu

# 16:9 幻灯片尺寸
SLIDE_WIDTH = Inches(13.333)   # 标准宽度
SLIDE_HEIGHT = Inches(7.5)     # 标准高度

def convert_position(x: float, y: float, w: float, h: float):
    """将归一化坐标转换为PPTX坐标"""
    return {
        "left": Emu(x * SLIDE_WIDTH),
        "top": Emu(y * SLIDE_HEIGHT),
        "width": Emu(w * SLIDE_WIDTH),
        "height": Emu(h * SLIDE_HEIGHT),
    }
```

### 3.7.7 样式应用

将StyleConfig转换为PPTX样式：

| StyleConfig字段 | PPTX对应 | 说明 |
|-----------------|----------|------|
| color.primary | RGBColor | 主色调 |
| color.text | font.color | 文字颜色 |
| font.title_family | font.name | 标题字体 |
| font.title_size | font.size (Points) | 标题字号 |
| font.body_size | font.size (Points) | 正文字号 |

### 3.7.8 API设计

**请求**：
```json
{
  "session_id": "xxx",
  "format": "pptx",
  "include_notes": true,
  "embed_images": true
}
```

**响应**：
```json
{
  "status": "ok",
  "file_url": "/api/download/xxx.pptx",
  "file_size_bytes": 1234567,
  "page_count": 10
}
```

### 3.7.9 导出质量保证

- **字体回退**：检测目标系统字体可用性，提供备选字体
- **图片压缩**：根据用途调整图片质量，控制文件大小
- **兼容性测试**：确保在WPS、LibreOffice中也能正常打开

---

## 附录A：工作流引擎

> 注：工作流引擎作为系统基础设施，贯穿 3.1-3.7 各模块。

### A.1 会话状态 (`SessionState`)

| 字段名称 | 数据类型 | 说明 |
|----------|----------|------|
| **session_id** | 字符串 | 会话唯一标识 |
| **created_at** | 字符串 | 创建时间（ISO 8601） |
| **updated_at** | 字符串 | 最后更新时间 |
| **teaching_request** | TeachingRequest | 3.1模块输出 |
| **style_config** | StyleConfig | 3.2模块输出 |
| **outline** | PPTOutline | 3.3模块输出 |
| **deck_content** | SlideDeckContent | 3.4模块输出 |
| **stage** | 枚举 | 当前阶段（3.1/3.2/3.3/3.4/3.5/3.6/3.7） |

### A.2 错误处理机制

- **LLM降级**：LLM调用失败时降级到确定性生成
- **素材降级**：AI生成失败时使用占位图
- **会话恢复**：支持从中间状态恢复执行
- **详细日志**：记录各阶段执行信息便于调试

---

## 模块间数据流转总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户输入                                    │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3.1 意图理解                                                        │
│  输出: TeachingRequest                                               │
│       - subject, professional_category, teaching_scene             │
│       - knowledge_points[], teaching_objectives                      │
│       - slide_requirements: {target_count, min_count, max_count}    │
│       - special_requirements (cases/exercises/interaction)          │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ 页面冲突检测          │
                    │ (confirm_goals阶段)   │
                    └───────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
             有冲突 │                       │ 无冲突
                    │                       │
                    ▼                       ▼
        ┌───────────────────┐   ┌───────────────────┐
        │ LLM推荐页数       │   │ 直接进入3.2       │
        │ 用户选择处理方式  │   │                   │
        └───────────────────┘   └───────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3.2 风格设计                                                        │
│  输入: TeachingRequest.teaching_scene                                │
│  输出: StyleConfig                                                   │
│       - style_name, color{}, font{}, layout{}, imagery{}            │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3.3 大纲生成                                                        │
│  输入: TeachingRequest + StyleConfig.style_name                      │
│  输出: PPTOutline                                                    │
│       - deck_title, slides[]: {index, slide_type, title, bullets,   │
│         notes, interactions, assets}                                │
│                                                                      │
│  如果页数超限 → 智能调整（三级优先级策略）                            │
│    - 优先级1: 移除非必要页面                                         │
│    - 优先级2: 合并相似内容页面                                       │
│    - 优先级3: 内容简化                                               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3.4 内容生成                                                        │
│  输入: TeachingRequest + StyleConfig + PPTOutline                    │
│  输出: SlideDeckContent                                              │
│       - pages[]: {index, slide_type, title, elements[], layout}     │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3.5 渲染 → HTML幻灯片                                               │
│  3.6 素材匹配 → 完整课件                                              │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 附录：关键 JSON Schema 汇总

### StyleConfig (3.2 输出)

```json
{
  "style_name": "theory_clean",
  "color": {
    "primary": "#1F4E79",
    "secondary": "#F3F5F7",
    "accent": "#2E75B6",
    "text": "#111827",
    "background": "#FFFFFF",
    "warning": "#DC2626"
  },
  "font": {
    "title_family": "Microsoft YaHei",
    "body_family": "Microsoft YaHei",
    "title_size": 36,
    "body_size": 22
  },
  "layout": {
    "density": "comfortable",
    "alignment": "left"
  },
  "imagery": {
    "image_style": "clean_diagram",
    "chart_preference": ["mindmap", "flow", "table"]
  }
}
```

### PPTOutline (3.3 输出)

```json
{
  "deck_title": "液压传动系统基础",
  "subject": "机械",
  "knowledge_points": ["液压传动原理", "液压泵结构", "控制阀原理", "密封技术"],
  "teaching_scene": "theory",
  "slides": [
    {
      "index": 1,
      "slide_type": "cover",
      "title": "液压传动系统基础",
      "bullets": [],
      "notes": null,
      "interactions": [],
      "assets": [
        {
          "type": "image",
          "theme": "液压传动系统整体图",
          "size": "16:9",
          "style": "photo"
        }
      ]
    },
    {
      "index": 2,
      "slide_type": "agenda",
      "title": "课程目录",
      "bullets": ["液压传动原理", "液压泵结构", "控制阀原理", "密封技术", "案例分析", "练习与互动", "总结"],
      "notes": null,
      "interactions": [],
      "assets": []
    },
    {
      "index": 3,
      "slide_type": "objectives",
      "title": "教学目标",
      "bullets": ["知识目标：掌握液压传动原理、系统组成和优缺点", "能力目标：能分析液压系统、识别元件、理解应用", "素养目标：培养工程思维、增强技术理解、建立整体观念"],
      "notes": null,
      "interactions": [],
      "assets": [
        {
          "type": "diagram",
          "theme": "教学目标结构图",
          "size": "medium",
          "style": "mindmap"
        }
      ]
    },
    {
      "index": 13,
      "slide_type": "concept",
      "title": "案例一：挖掘机液压系统分析",
      "bullets": ["案例背景：挖掘机工作装置", "液压系统组成分析", "工作原理详解", "故障模拟与诊断"],
      "notes": null,
      "interactions": ["案例分析：分组讨论故障原因"],
      "assets": [
        {
          "type": "image",
          "theme": "挖掘机液压系统图",
          "size": "16:9",
          "style": "photo"
        }
      ]
    },
    {
      "index": 17,
      "slide_type": "qa",
      "title": "问答互动",
      "bullets": ["提问：液压传动与机械传动的区别？", "学生回答与讨论", "教师点评与总结"],
      "notes": null,
      "interactions": ["提问互动：现场随机提问"],
      "assets": []
    }
  ]
}
```

**说明**：
- `bullets` 可以为空数组（如cover页）
- `notes` 通常为 `null`
- `interactions` 和 `assets` 可以为空数组
- 案例页使用 `slide_type: "concept"`，通过标题区分
- 互动页使用 `slide_type: "qa"`

### SlideDeckContent (3.4 输出)

```json
{
  "deck_title": "机械：液压传动原理",
  "pages": [
    {
      "index": 0,
      "slide_type": "cover",
      "title": "液压传动原理",
      "layout": {"template": "cover_centered"},
      "elements": [
        {
          "id": "uuid-xxx",
          "type": "text",
          "x": 0.1,
          "y": 0.4,
          "w": 0.8,
          "h": 0.2,
          "content": {"text": "液压传动原理"},
          "style": {"font_size": 48}
        }
      ],
      "speaker_notes": null
    }
  ]
}
```
